<%- include('../partials/header', { title: 'Admin Dashboard' }) %>

<div class="container-fluid py-4">
    <div class="row g-3 align-items-center mb-2">
        <div class="col-12 col-md-7">
            <h2 class="mb-1 d-flex align-items-center gap-2"><i class="bi bi-speedometer2"></i> Admin Dashboard</h2>
            <p class="text-muted mb-0">Overview of exams, submissions, categories and quick actions.</p>
        </div>
        <div class="col-12 col-md-5">
            <div class="d-flex flex-wrap justify-content-md-end gap-2">
                <a href="/admin/create-exam" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Create Exam</a>
                <a href="/admin/manage-exams" class="btn btn-outline-secondary"><i class="bi bi-gear"></i> Manage</a>
                <a href="/admin/exam-reports" class="btn btn-outline-primary"><i class="bi bi-bar-chart"></i> Reports</a>
            </div>
        </div>
    </div>

    <!-- Welcome banner -->
    <div class="card mb-3 border-0 shadow-sm" style="background: linear-gradient(135deg, #0d6efd 0%, #5ab1ff 100%);">
        <div class="card-body text-white">
            <div class="row align-items-center g-3">
                <div class="col-12 col-lg-8">
                    <h4 class="mb-1">Welcome back, Admin</h4>
                    <p class="mb-0 opacity-75">Create, manage and monitor exams with the tools below.</p>
                </div>
                <div class="col-12 col-lg-4">
                    <div class="d-grid d-md-flex justify-content-md-end gap-2">
                        <a href="/admin/create-exam" class="btn btn-light text-primary"><i class="bi bi-plus-circle"></i> New Exam</a>
                        <a href="/admin/manage-categories" class="btn btn-outline-light"><i class="bi bi-tags"></i> Categories</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <!-- Stats cards -->
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card shadow-sm h-100 border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted">Exams</h6>
                            <h3 class="mb-0"><%= exams %></h3>
                        </div>
                        <div class="dash-icon bg-primary-subtle text-primary">
                            <i class="bi bi-journal-text"></i>
                        </div>
                    </div>
                    <small class="text-muted">Total exams created</small>
                </div>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card shadow-sm h-100 border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted">Submissions</h6>
                            <h3 class="mb-0"><%= submissions %></h3>
                        </div>
                        <div class="dash-icon bg-success-subtle text-success">
                            <i class="bi bi-clipboard-check"></i>
                        </div>
                    </div>
                    <small class="text-muted">Completed submissions</small>
                </div>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card shadow-sm h-100 border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted">Categories</h6>
                            <h3 class="mb-0"><%= categories %></h3>
                        </div>
                        <div class="dash-icon bg-info-subtle text-info">
                            <i class="bi bi-tags"></i>
                        </div>
                    </div>
                    <small class="text-muted"><a href="/admin/manage-categories">Manage categories</a></small>
                </div>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card shadow-sm h-100 border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted">Active Exams</h6>
                            <h3 class="mb-0"><%= recentExams.filter(e => e.isActive).length %></h3>
                        </div>
                        <div class="dash-icon bg-warning-subtle text-warning">
                            <i class="bi bi-play-circle"></i>
                        </div>
                    </div>
                    <div class="mt-2">
                        <div class="progress" style="height: 6px;">
                            <% const total = recentExams.length || 1; const act = recentExams.filter(e => e.isActive).length; const pct = Math.round((act/total)*100); %>
                            <div class="progress-bar bg-warning" role="progressbar" style="width: <%= pct %>%" aria-valuenow="<%= pct %>" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <small class="text-muted">Active ratio: <%= pct %>%</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12 col-xxl-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3 gap-2">
                        <h5 class="card-title mb-0">Recent Exams</h5>
                        <div class="d-flex flex-column flex-md-row gap-2 w-100 w-md-auto">
                            <div class="btn-group" role="group" aria-label="Filter exams">
                                <button type="button" class="btn btn-outline-secondary btn-sm active" data-status="">All</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" data-status="active">Active</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" data-status="inactive">Inactive</button>
                            </div>
                            <div class="input-group" style="max-width: 320px;">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" id="dashExamSearch" class="form-control" placeholder="Search exams">
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Subject</th>
                                    <th>Category</th>
                                    <th>Questions</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                </tr>
                            </thead>
                            <tbody id="dashExamBody">
                                <% if (recentExams && recentExams.length > 0) { %>
                                    <% recentExams.forEach(exam => { %>
                                        <tr data-status="<%= exam.isActive ? 'active' : 'inactive' %>">
                                            <td class="fw-semibold">
                                                <%= exam.title %>
                                                <% if (exam.isActive) { %>
                                                    <span class="badge bg-success ms-1 d-inline d-lg-none">Active</span>
                                                <% } else { %>
                                                    <span class="badge bg-secondary ms-1 d-inline d-lg-none">Inactive</span>
                                                <% } %>
                                            </td>
                                            <td><%= exam.subject || '-' %></td>
                                            <td>
                                                <% if (exam.category && exam.category.name) { %>
                                                    <span class="badge bg-light text-dark"><%= exam.category.name %></span>
                                                <% } else { %>
                                                    -
                                                <% } %>
                                            </td>
                                            <td><%= exam.questions.length %></td>
                                            <td><%= exam.duration %> min</td>
                                            <td>
                                                <% if (exam.isActive) { %>
                                                    <span class="badge bg-success">Active</span>
                                                <% } else { %>
                                                    <span class="badge bg-secondary">Inactive</span>
                                                <% } %>
                                            </td>
                                            <td><%= new Date(exam.createdAt).toLocaleDateString() %></td>
                                        </tr>
                                    <% }) %>
                                <% } else { %>
                                    <tr><td colspan="7" class="text-center">No recent exams</td></tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        
    </div>
 </div>
 </div>

<%- include('../partials/footer') %>
<script>
  (function(){
    const input = document.getElementById('dashExamSearch');
    const filterButtons = document.querySelectorAll('[data-status]');
    let currentStatus = '';
    function apply() {
      const q = (input && input.value ? input.value : '').toLowerCase();
      document.querySelectorAll('#dashExamBody tr').forEach(tr => {
        const text = tr.innerText.toLowerCase();
        const status = tr.getAttribute('data-status') || '';
        const byText = text.includes(q);
        const byStatus = !currentStatus || status === currentStatus;
        tr.style.display = (byText && byStatus) ? '' : 'none';
      });
    }
    if (input) input.addEventListener('input', apply);
    filterButtons.forEach(btn => {
      btn.addEventListener('click', function(){
        filterButtons.forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentStatus = this.getAttribute('data-status');
        apply();
      });
    });
    // Live updates for dashboard
    try {
      const socket = io();
      socket.on('connect', function(){ socket.emit('join-admin'); });
      socket.on('exams:update', function(){ location.reload(); });
      socket.on('categories:update', function(){ location.reload(); });
      socket.on('reports:update', function(){ location.reload(); });
    } catch(e) {}
  })();
</script>